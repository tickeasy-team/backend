/**
 * å®‰å…¨çš„çŸ¥è­˜åº«æ•¸æ“šåˆå§‹åŒ–è…³æœ¬
 * åªæœ‰åœ¨æ•¸æ“šåº«ç‚ºç©ºæ™‚æ‰æ’å…¥æ¸¬è©¦æ•¸æ“š
 */

import { supabaseService } from './services/supabase-service.js';

const testData = [
  {
    title: 'å¦‚ä½•è³¼è²·æ¼”å”±æœƒé–€ç¥¨',
    content: 'è³¼è²·æ¼”å”±æœƒé–€ç¥¨çš„æ­¥é©Ÿï¼š1. è¨»å†Šæˆ–ç™»å…¥ Tickeasy å¸³è™Ÿ 2. ç€è¦½æ¼”å”±æœƒæ´»å‹•é é¢ 3. é¸æ“‡å ´æ¬¡å’Œåº§ä½ 4. å¡«å¯«è³¼ç¥¨è³‡è¨Š 5. é¸æ“‡ä»˜æ¬¾æ–¹å¼ 6. å®Œæˆä»˜æ¬¾ä¸¦å–å¾—é›»å­ç¥¨åˆ¸ã€‚è³¼ç¥¨æ™‚è«‹æ³¨æ„ç¥¨ç¨®é™åˆ¶å’Œè³¼ç¥¨æ•¸é‡é™åˆ¶ã€‚',
    category: 'è³¼ç¥¨æµç¨‹',
    tags: ['è³¼ç¥¨', 'æ¼”å”±æœƒ', 'é–€ç¥¨', 'æµç¨‹']
  },
  {
    title: 'ç¥¨åˆ¸é€€æ›ç¥¨æ”¿ç­–',
    content: 'é€€æ›ç¥¨æ”¿ç­–èªªæ˜ï¼š1. ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œé–€ç¥¨å”®å‡ºå¾Œä¸å¾—é€€æ› 2. å¦‚å› ä¸»è¾¦æ–¹å–æ¶ˆæ´»å‹•ï¼Œå¯ç”³è«‹å…¨é¡é€€æ¬¾ 3. å¦‚å› ä¸å¯æŠ—åŠ›å› ç´ ï¼ˆå¤©ç½ã€ç–«æƒ…ç­‰ï¼‰å°è‡´æ´»å‹•å–æ¶ˆï¼Œå¯ç”³è«‹é€€æ¬¾ 4. é€€ç¥¨ç”³è«‹éœ€åœ¨æ´»å‹•é–‹å§‹å‰7å¤©æå‡º 5. é€€æ¬¾è™•ç†æ™‚é–“ç‚º7-14å€‹å·¥ä½œå¤©ã€‚è©³ç´°é€€ç¥¨æ¢æ¬¾è«‹åƒè€ƒå„æ´»å‹•é é¢èªªæ˜ã€‚',
    category: 'é€€æ›ç¥¨',
    tags: ['é€€ç¥¨', 'æ›ç¥¨', 'æ”¿ç­–', 'é€€æ¬¾']
  },
  {
    title: 'æ”¯æ´çš„ä»˜æ¬¾æ–¹å¼',
    content: 'Tickeasy æ”¯æ´å¤šç¨®ä»˜æ¬¾æ–¹å¼ï¼š1. ä¿¡ç”¨å¡ä»˜æ¬¾ï¼ˆVisaã€MasterCardã€JCBï¼‰ 2. é‡‘èå¡ä»˜æ¬¾ 3. ATM è½‰å¸³ 4. è¶…å•†ä»£ç¢¼ç¹³è²»ï¼ˆ7-11ã€å…¨å®¶ã€èŠçˆ¾å¯Œï¼‰ 5. è¡Œå‹•æ”¯ä»˜ï¼ˆLine Payã€è¡—å£æ”¯ä»˜ã€Apple Payï¼‰ 6. éŠ€è¡Œè½‰å¸³ã€‚æ¨è–¦ä½¿ç”¨ä¿¡ç”¨å¡ä»˜æ¬¾ï¼Œå¯äº«æœ‰è³¼ç‰©ä¿éšœã€‚ä»˜æ¬¾å®Œæˆå¾Œæœƒç«‹å³æ”¶åˆ°é›»å­ç¥¨åˆ¸ã€‚',
    category: 'ä»˜æ¬¾',
    tags: ['ä»˜æ¬¾', 'ä¿¡ç”¨å¡', 'è½‰å¸³', 'è¶…å•†', 'è¡Œå‹•æ”¯ä»˜']
  },
  {
    title: 'é›»å­ç¥¨åˆ¸ä½¿ç”¨èªªæ˜',
    content: 'é›»å­ç¥¨åˆ¸ä½¿ç”¨æ–¹å¼ï¼š1. è³¼ç¥¨æˆåŠŸå¾Œæœƒæ”¶åˆ°é›»å­ç¥¨åˆ¸ QR Code 2. å¯é€éæ‰‹æ©Ÿ APP æˆ–é›»å­éƒµä»¶æŸ¥çœ‹ç¥¨åˆ¸ 3. å…¥å ´æ™‚å‡ºç¤º QR Code ä¾›å·¥ä½œäººå“¡æƒæ 4. è«‹ç¢ºä¿æ‰‹æ©Ÿé›»é‡å……è¶³å’Œè¢å¹•äº®åº¦è¶³å¤  5. å»ºè­°æå‰æˆªåœ–ä¿å­˜ç¥¨åˆ¸è³‡è¨Š 6. æ¯å¼µç¥¨åˆ¸åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè«‹å‹¿é‡è¤‡å…¥å ´ã€‚éºå¤±ç¥¨åˆ¸å¯è¯ç¹«å®¢æœå”åŠ©è™•ç†ã€‚',
    category: 'ç¥¨åˆ¸ä½¿ç”¨',
    tags: ['é›»å­ç¥¨åˆ¸', 'QR Code', 'å…¥å ´', 'æ‰‹æ©Ÿ']
  },
  {
    title: 'åº§ä½é¸æ“‡å’Œç¥¨ç¨®èªªæ˜',
    content: 'åº§ä½é¸æ“‡æŒ‡å—ï¼š1. VIP å€åŸŸï¼šæœ€ä½³è¦–é‡ï¼ŒåŒ…å«ç‰¹æ®Šç¦®å“å’Œæœå‹™ 2. æ–æ»¾å€ï¼šæœ€æ¥è¿‘èˆå°ï¼Œç«™ç¥¨å½¢å¼ï¼Œæ°£æ°›æœ€ç†±çƒˆ 3. å…§é‡å€ï¼šåç¥¨å€åŸŸï¼Œè¦–é‡è‰¯å¥½ 4. å¤–é‡å€ï¼šç¶“æ¿Ÿå¯¦æƒ é¸æ“‡ï¼Œè·é›¢è¼ƒé ä½†ä»å¯æ¸…æ¥šè§€è³ 5. ç„¡éšœç¤™åº§ä½ï¼šæä¾›è¼ªæ¤…ä½¿ç”¨è€…å°ˆç”¨åº§ä½ã€‚è³¼ç¥¨æ™‚å¯é€éåº§ä½åœ–é¸æ“‡å–œå¥½ä½ç½®ï¼Œå…ˆæ¶å…ˆè´ã€‚',
    category: 'åº§ä½ç¥¨ç¨®',
    tags: ['åº§ä½', 'ç¥¨ç¨®', 'VIP', 'æ–æ»¾å€', 'é¸æ“‡']
  }
];

async function initKnowledgeBase() {
  console.log('ğŸš€ é–‹å§‹å®‰å…¨åˆå§‹åŒ–çŸ¥è­˜åº«æ•¸æ“š...');
  
  try {
    // 1. æª¢æŸ¥ Supabase é€£æ¥
    console.log('ğŸ”— æª¢æŸ¥ Supabase é€£æ¥...');
    const isConnected = await supabaseService.testConnection();
    
    if (!isConnected) {
      console.error('âŒ Supabase é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸è¨­å®š');
      process.exit(1);
    }
    
    console.log('âœ… Supabase é€£æ¥æ­£å¸¸');

    // 2. æª¢æŸ¥ç¾æœ‰æ•¸æ“š
    console.log('ğŸ“Š æª¢æŸ¥ç¾æœ‰çŸ¥è­˜åº«æ•¸æ“š...');
    const stats = await supabaseService.getKnowledgeBaseStats();
    
    console.log(`ğŸ“ˆ ç•¶å‰çŸ¥è­˜åº«çµ±è¨ˆ: ç¸½æ•¸ ${stats.total}, æ´»èº ${stats.active}`);

    if (stats.active > 0) {
      console.log('âš ï¸  çŸ¥è­˜åº«å·²æœ‰æ•¸æ“šï¼Œè·³éåˆå§‹åŒ–');
      console.log('ğŸ’¡ å¦‚éœ€é‡æ–°åˆå§‹åŒ–ï¼Œè«‹å…ˆæ¸…ç©ºçŸ¥è­˜åº«æˆ–æ‰‹å‹•åˆªé™¤ç¾æœ‰æ•¸æ“š');
      return;
    }

    // 3. æ’å…¥æ¸¬è©¦æ•¸æ“š
    console.log('ğŸ“ é–‹å§‹æ’å…¥æ¸¬è©¦æ•¸æ“š...');
    const client = supabaseService.getClient();
    
    let successCount = 0;
    
    for (const data of testData) {
      try {
        console.log(`ğŸ“„ æ’å…¥: "${data.title}"`);
        
        const { data: insertResult, error } = await client
          .from('support_knowledge_base')
          .insert({
            title: data.title,
            content: data.content,
            category: data.category,
            tags: data.tags,
            is_active: true,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .select();

        if (error) {
          console.error(`âŒ æ’å…¥å¤±æ•—: "${data.title}"`, error.message);
        } else {
          console.log(`âœ… æ’å…¥æˆåŠŸ: "${data.title}"`);
          successCount++;
        }
        
        // é¿å…éå¿«çš„è«‹æ±‚
        await new Promise(resolve => setTimeout(resolve, 200));
        
      } catch (error) {
        console.error(`âŒ æ’å…¥ç•°å¸¸: "${data.title}"`, error.message);
      }
    }

    // 4. é©—è­‰æ’å…¥çµæœ
    console.log('\\nğŸ” é©—è­‰æ’å…¥çµæœ...');
    const finalStats = await supabaseService.getKnowledgeBaseStats();
    
    console.log('\\n' + '='.repeat(50));
    console.log('ğŸ“Š åˆå§‹åŒ–çµæœç¸½çµ');
    console.log('='.repeat(50));
    console.log(`ğŸ“ å˜—è©¦æ’å…¥: ${testData.length} å€‹é …ç›®`);
    console.log(`âœ… æˆåŠŸæ’å…¥: ${successCount} å€‹é …ç›®`);
    console.log(`ğŸ“ˆ æœ€çµ‚çµ±è¨ˆ: ç¸½æ•¸ ${finalStats.total}, æ´»èº ${finalStats.active}`);
    console.log(`ğŸ“‚ åˆ†é¡æ•¸é‡: ${finalStats.categories.length}`);
    
    if (finalStats.categories.length > 0) {
      console.log('\\nğŸ“‹ åˆ†é¡è©³æƒ…:');
      finalStats.categories.forEach(cat => {
        console.log(`   - ${cat.name}: ${cat.count} å€‹é …ç›®`);
      });
    }

    if (successCount === testData.length) {
      console.log('\\nğŸ‰ çŸ¥è­˜åº«åˆå§‹åŒ–å®Œæˆï¼');
      console.log('âœ¨ ç¾åœ¨å¯ä»¥æ¸¬è©¦æœå°‹å’Œæ™ºèƒ½å®¢æœåŠŸèƒ½äº†');
      console.log('ğŸš€ åŸ·è¡Œæ¸¬è©¦: npm run test:smart-customer-service');
    } else {
      console.log('\\nâš ï¸  éƒ¨åˆ†æ•¸æ“šæ’å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤è¨Šæ¯');
    }
    
    console.log('='.repeat(50));

  } catch (error) {
    console.error('ğŸ’¥ åˆå§‹åŒ–éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
    console.error('ğŸ”§ è«‹æª¢æŸ¥:');
    console.error('   1. Supabase é€£æ¥è¨­å®š');
    console.error('   2. è³‡æ–™åº« schema æ˜¯å¦æ­£ç¢º');
    console.error('   3. ç’°å¢ƒè®Šæ•¸æ˜¯å¦å®Œæ•´');
    process.exit(1);
  }
}

// åŸ·è¡Œåˆå§‹åŒ–
async function run() {
  console.log('ğŸ“‹ çŸ¥è­˜åº«å®‰å…¨åˆå§‹åŒ–');
  console.log('- åªåœ¨è³‡æ–™åº«ç‚ºç©ºæ™‚æ’å…¥æ•¸æ“š');
  console.log('- ä½¿ç”¨ Supabase å®¢æˆ¶ç«¯ç›´æ¥æ“ä½œ');
  console.log('- é©åˆç”Ÿç”¢ç’°å¢ƒä½¿ç”¨\\n');
  
  await initKnowledgeBase();
}

run().catch(console.error);
