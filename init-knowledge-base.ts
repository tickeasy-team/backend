/**
 * çŸ¥è­˜åº«åˆå§‹åŒ–è…³æœ¬
 * æ·»åŠ åŸºæœ¬çš„å®¢æœçŸ¥è­˜åº«æ•¸æ“š
 */

import 'reflect-metadata';
import { AppDataSource } from './config/database.js';
import { SupportKnowledgeBase } from './models/support-knowledge-base.js';
import { embeddingService } from './services/embedding-service.js';

const initialKnowledgeBase = [
  {
    title: 'å¦‚ä½•è³¼è²·æ¼”å”±æœƒé–€ç¥¨',
    content: 'è³¼è²·æ¼”å”±æœƒé–€ç¥¨çš„æ­¥é©Ÿï¼š1. è¨»å†Šæˆ–ç™»å…¥ Tickeasy å¸³è™Ÿ 2. ç€è¦½æ¼”å”±æœƒæ´»å‹•é é¢ 3. é¸æ“‡å ´æ¬¡å’Œåº§ä½ 4. å¡«å¯«è³¼ç¥¨è³‡è¨Š 5. é¸æ“‡ä»˜æ¬¾æ–¹å¼ 6. å®Œæˆä»˜æ¬¾ä¸¦å–å¾—é›»å­ç¥¨åˆ¸ã€‚è³¼ç¥¨æ™‚è«‹æ³¨æ„ç¥¨ç¨®é™åˆ¶å’Œè³¼ç¥¨æ•¸é‡é™åˆ¶ã€‚å»ºè­°æå‰è¨»å†Šæœƒå“¡ä»¥åŠ å¿«è³¼ç¥¨æµç¨‹ã€‚',
    category: 'è³¼ç¥¨æµç¨‹',
    tags: ['è³¼ç¥¨', 'æ¼”å”±æœƒ', 'é–€ç¥¨', 'æµç¨‹', 'è¨»å†Š']
  },
  {
    title: 'ç¥¨åˆ¸é€€æ›ç¥¨æ”¿ç­–',
    content: 'é€€æ›ç¥¨æ”¿ç­–èªªæ˜ï¼š1. ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œé–€ç¥¨å”®å‡ºå¾Œä¸å¾—é€€æ› 2. å¦‚å› ä¸»è¾¦æ–¹å–æ¶ˆæ´»å‹•ï¼Œå¯ç”³è«‹å…¨é¡é€€æ¬¾ 3. å¦‚å› ä¸å¯æŠ—åŠ›å› ç´ ï¼ˆå¤©ç½ã€ç–«æƒ…ç­‰ï¼‰å°è‡´æ´»å‹•å–æ¶ˆï¼Œå¯ç”³è«‹é€€æ¬¾ 4. é€€ç¥¨ç”³è«‹éœ€åœ¨æ´»å‹•é–‹å§‹å‰7å¤©æå‡º 5. é€€æ¬¾è™•ç†æ™‚é–“ç‚º7-14å€‹å·¥ä½œå¤© 6. é€€ç¥¨éœ€æ”¶å–10%æ‰‹çºŒè²»ã€‚è©³ç´°é€€ç¥¨æ¢æ¬¾è«‹åƒè€ƒå„æ´»å‹•é é¢èªªæ˜ã€‚',
    category: 'é€€æ›ç¥¨',
    tags: ['é€€ç¥¨', 'æ›ç¥¨', 'æ”¿ç­–', 'é€€æ¬¾', 'æ‰‹çºŒè²»']
  },
  {
    title: 'æ”¯æ´çš„ä»˜æ¬¾æ–¹å¼',
    content: 'Tickeasy æ”¯æ´å¤šç¨®ä»˜æ¬¾æ–¹å¼ï¼š1. ä¿¡ç”¨å¡ä»˜æ¬¾ï¼ˆVisaã€MasterCardã€JCBã€ç¾åœ‹é‹é€šï¼‰ 2. é‡‘èå¡ä»˜æ¬¾ 3. ATM è½‰å¸³ 4. è¶…å•†ä»£ç¢¼ç¹³è²»ï¼ˆ7-11ã€å…¨å®¶ã€èŠçˆ¾å¯Œã€OK martï¼‰ 5. è¡Œå‹•æ”¯ä»˜ï¼ˆLine Payã€è¡—å£æ”¯ä»˜ã€Apple Payã€Google Payï¼‰ 6. éŠ€è¡Œè½‰å¸³ã€‚æ¨è–¦ä½¿ç”¨ä¿¡ç”¨å¡ä»˜æ¬¾ï¼Œå¯äº«æœ‰è³¼ç‰©ä¿éšœå’Œåˆ†æœŸä»˜æ¬¾æœå‹™ã€‚ä»˜æ¬¾å®Œæˆå¾Œæœƒç«‹å³æ”¶åˆ°é›»å­ç¥¨åˆ¸ã€‚',
    category: 'ä»˜æ¬¾',
    tags: ['ä»˜æ¬¾', 'ä¿¡ç”¨å¡', 'è½‰å¸³', 'è¶…å•†', 'è¡Œå‹•æ”¯ä»˜', 'åˆ†æœŸ']
  },
  {
    title: 'é›»å­ç¥¨åˆ¸ä½¿ç”¨èªªæ˜',
    content: 'é›»å­ç¥¨åˆ¸ä½¿ç”¨æ–¹å¼ï¼š1. è³¼ç¥¨æˆåŠŸå¾Œæœƒæ”¶åˆ°é›»å­ç¥¨åˆ¸ QR Code 2. å¯é€éæ‰‹æ©Ÿ APP æˆ–é›»å­éƒµä»¶æŸ¥çœ‹ç¥¨åˆ¸ 3. å…¥å ´æ™‚å‡ºç¤º QR Code ä¾›å·¥ä½œäººå“¡æƒæ 4. è«‹ç¢ºä¿æ‰‹æ©Ÿé›»é‡å……è¶³å’Œè¢å¹•äº®åº¦è¶³å¤  5. å»ºè­°æå‰æˆªåœ–ä¿å­˜ç¥¨åˆ¸è³‡è¨Šä½œç‚ºå‚™ä»½ 6. æ¯å¼µç¥¨åˆ¸åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè«‹å‹¿é‡è¤‡å…¥å ´ 7. å¯å°‡ç¥¨åˆ¸è½‰ç™¼çµ¦åŒè¡Œå‹äººã€‚éºå¤±ç¥¨åˆ¸å¯è¯ç¹«å®¢æœå”åŠ©é‡æ–°ç™¼é€ã€‚',
    category: 'ç¥¨åˆ¸ä½¿ç”¨',
    tags: ['é›»å­ç¥¨åˆ¸', 'QR Code', 'å…¥å ´', 'æ‰‹æ©Ÿ', 'APP', 'å‚™ä»½']
  },
  {
    title: 'åº§ä½é¸æ“‡å’Œç¥¨ç¨®èªªæ˜',
    content: 'åº§ä½é¸æ“‡æŒ‡å—ï¼š1. VIP å€åŸŸï¼šæœ€ä½³è¦–é‡ï¼ŒåŒ…å«ç‰¹æ®Šç¦®å“å’Œå°ˆå±¬æœå‹™ï¼Œåƒ¹æ ¼æœ€é«˜ 2. æ–æ»¾å€ï¼šæœ€æ¥è¿‘èˆå°ï¼Œç«™ç¥¨å½¢å¼ï¼Œæ°£æ°›æœ€ç†±çƒˆï¼Œé©åˆå¹´è¼•è§€çœ¾ 3. å…§é‡å€ï¼šåç¥¨å€åŸŸï¼Œè¦–é‡è‰¯å¥½ï¼Œèˆ’é©åº¦ä½³ 4. å¤–é‡å€ï¼šç¶“æ¿Ÿå¯¦æƒ é¸æ“‡ï¼Œè·é›¢è¼ƒé ä½†ä»å¯æ¸…æ¥šè§€è³ 5. ç„¡éšœç¤™åº§ä½ï¼šæä¾›è¼ªæ¤…ä½¿ç”¨è€…å’Œè¡Œå‹•ä¸ä¾¿è€…å°ˆç”¨åº§ä½ï¼Œéœ€äº‹å…ˆç”³è«‹ã€‚è³¼ç¥¨æ™‚å¯é€éäº’å‹•å¼åº§ä½åœ–é¸æ“‡å–œå¥½ä½ç½®ï¼Œæ¡å…ˆæ¶å…ˆè´åˆ¶åº¦ã€‚',
    category: 'åº§ä½ç¥¨ç¨®',
    tags: ['åº§ä½', 'ç¥¨ç¨®', 'VIP', 'æ–æ»¾å€', 'é¸æ“‡', 'ç„¡éšœç¤™']
  },
  {
    title: 'æœƒå“¡è¨»å†Šå’Œå¸³è™Ÿç®¡ç†',
    content: 'æœƒå“¡æœå‹™èªªæ˜ï¼š1. å…è²»è¨»å†Š Tickeasy æœƒå“¡äº«æœ‰å¤šé …å„ªæƒ  2. æœƒå“¡å¯ç²å¾—æ´»å‹•æ¶å…ˆè³¼ç¥¨è³‡æ ¼ 3. ç´¯ç©è³¼ç¥¨é‡‘é¡å¯å‡ç´šç‚º VIP æœƒå“¡ 4. æœƒå“¡å¯è¨­å®šæ„Ÿèˆˆè¶£çš„è—äººï¼Œæ¥æ”¶æ¼”å‡ºé€šçŸ¥ 5. å¯ç®¡ç†å€‹äººè³¼ç¥¨è¨˜éŒ„å’Œé›»å­ç¥¨åˆ¸ 6. å¿˜è¨˜å¯†ç¢¼å¯é€éé›»å­éƒµä»¶é‡è¨­ 7. å¯ç¶å®šç¤¾ç¾¤å¸³è™Ÿå¿«é€Ÿç™»å…¥ã€‚å»ºè­°å®Œæ•´å¡«å¯«å€‹äººè³‡æ–™ä»¥åŠ å¿«è³¼ç¥¨æµç¨‹ã€‚',
    category: 'æœƒå“¡æœå‹™',
    tags: ['æœƒå“¡', 'è¨»å†Š', 'å¸³è™Ÿ', 'VIP', 'å„ªæƒ ', 'é€šçŸ¥']
  },
  {
    title: 'æ´»å‹•å–æ¶ˆå’Œå»¶æœŸè™•ç†',
    content: 'æ´»å‹•ç•°å‹•è™•ç†æ–¹å¼ï¼š1. å¦‚ä¸»è¾¦æ–¹å®£å¸ƒæ´»å‹•å–æ¶ˆï¼Œå°‡ä¸»å‹•é€šçŸ¥ä¸¦æä¾›å…¨é¡é€€æ¬¾ 2. æ´»å‹•å»¶æœŸæ™‚ï¼ŒåŸç¥¨åˆ¸ä»ç„¶æœ‰æ•ˆï¼Œå¯ä½¿ç”¨æ–¼æ–°æ—¥æœŸ 3. ç„¡æ³•åƒåŠ å»¶æœŸæ´»å‹•è€…å¯ç”³è«‹é€€ç¥¨ 4. å› å¤©ç½æˆ–ä¸å¯æŠ—åŠ›å› ç´ å–æ¶ˆï¼Œæä¾›å…¨é¡é€€æ¬¾ä¸”å…æ‰‹çºŒè²» 5. é€€æ¬¾å°‡ä¾åŸä»˜æ¬¾æ–¹å¼é€€å› 6. ç›¸é—œç•°å‹•æ¶ˆæ¯æœƒé€éç°¡è¨Šã€é›»å­éƒµä»¶å’Œå®˜ç¶²å…¬å‘Šã€‚å»ºè­°é—œæ³¨å®˜æ–¹æ¶ˆæ¯ä»¥ç²å¾—æœ€æ–°è³‡è¨Šã€‚',
    category: 'æ´»å‹•ç•°å‹•',
    tags: ['å–æ¶ˆ', 'å»¶æœŸ', 'é€€æ¬¾', 'å¤©ç½', 'é€šçŸ¥', 'å®˜æ–¹']
  },
  {
    title: 'ç¥¨åˆ¸è½‰è®“å’Œè´ˆé€',
    content: 'ç¥¨åˆ¸è½‰è®“è¦å‰‡ï¼š1. é›»å­ç¥¨åˆ¸å¯é€éç³»çµ±é€²è¡Œåˆæ³•è½‰è®“ 2. è½‰è®“éœ€é›™æ–¹åŒæ„ä¸¦é€éå®˜æ–¹å¹³å°é€²è¡Œ 3. è½‰è®“ç¥¨åˆ¸éœ€ç¬¦åˆä¸»è¾¦æ–¹è¦å®š 4. ç¦æ­¢ä»¥è¶…éåŸåƒ¹è²©å”®ç¥¨åˆ¸ï¼ˆé»ƒç‰›è¡Œç‚ºï¼‰ 5. å¯å°‡ç¥¨åˆ¸è´ˆé€çµ¦è¦ªå‹ï¼Œä½†éœ€è¨»æ˜å—è´ˆäººè³‡è¨Š 6. éƒ¨åˆ†é™å®šæ´»å‹•ä¸å…è¨±è½‰è®“ 7. è½‰è®“è¨˜éŒ„æœƒä¿ç•™æ–¼ç³»çµ±ä¸­ã€‚é•è¦è½‰å”®å°‡è¢«åˆ—å…¥é»‘åå–®ä¸¦å–æ¶ˆè³¼ç¥¨è³‡æ ¼ã€‚',
    category: 'ç¥¨åˆ¸è½‰è®“',
    tags: ['è½‰è®“', 'è´ˆé€', 'é»ƒç‰›', 'è¦å‰‡', 'é»‘åå–®', 'é™å®š']
  },
  {
    title: 'å®¢æœè¯ç¹«æ–¹å¼',
    content: 'å®¢æœæœå‹™ç®¡é“ï¼š1. ç·šä¸Šå®¢æœèŠå¤©æ©Ÿå™¨äººï¼ˆ24å°æ™‚æœå‹™ï¼‰ 2. å®¢æœå°ˆç·šï¼š02-1234-5678ï¼ˆé€±ä¸€è‡³é€±äº” 9:00-18:00ï¼‰ 3. å®¢æœä¿¡ç®±ï¼šsupport@tickeasy.com 4. å®˜æ–¹ LINE å®¢æœ 5. Facebook ç²‰çµ²å°ˆé ç§è¨Š 6. ç¾å ´æœå‹™æ«ƒå°ï¼ˆé™æ´»å‹•ç•¶å¤©ï¼‰ 7. ç·Šæ€¥è¯ç¹«é›»è©±ï¼š0800-123-456ã€‚å»ºè­°å„ªå…ˆä½¿ç”¨ç·šä¸Šå®¢æœæˆ–é›»å­éƒµä»¶ï¼Œå›è¦†é€Ÿåº¦è¼ƒå¿«ã€‚',
    category: 'å®¢æœè¯ç¹«',
    tags: ['å®¢æœ', 'è¯ç¹«', 'é›»è©±', 'ä¿¡ç®±', 'LINE', 'ç·Šæ€¥']
  },
  {
    title: 'å¸¸è¦‹æŠ€è¡“å•é¡Œè§£æ±º',
    content: 'æŠ€è¡“å•é¡Œæ’é™¤ï¼š1. ç¶²é ç„¡æ³•é–‹å•Ÿï¼šæ¸…é™¤ç€è¦½å™¨å¿«å–å’Œ Cookie 2. ä»˜æ¬¾å¤±æ•—ï¼šæª¢æŸ¥ç¶²è·¯é€£ç·šå’Œä¿¡ç”¨å¡è³‡è¨Š 3. APP ç„¡æ³•ç™»å…¥ï¼šæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬æˆ–é‡æ–°å®‰è£ 4. QR Code ç„¡æ³•æƒæï¼šèª¿æ•´è¢å¹•äº®åº¦å’Œç¢ºä¿åœ–ç‰‡æ¸…æ™° 5. æ”¶ä¸åˆ°é›»å­ç¥¨åˆ¸ï¼šæª¢æŸ¥åƒåœ¾ä¿¡ä»¶åŒ£å’Œç°¡è¨Š 6. è³¼ç¥¨é é¢å¡ä½ï¼šé‡æ–°æ•´ç†é é¢æˆ–ä½¿ç”¨å…¶ä»–ç€è¦½å™¨ 7. ç³»çµ±ç¶­è­·æ™‚é–“ï¼šæ¯é€±ä¸‰å‡Œæ™¨ 2:00-4:00ã€‚å¦‚å•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«æŠ€è¡“å®¢æœã€‚',
    category: 'æŠ€è¡“æ”¯æ´',
    tags: ['æŠ€è¡“å•é¡Œ', 'æ•…éšœ', 'ç€è¦½å™¨', 'ä»˜æ¬¾', 'APP', 'ç¶­è­·']
  }
];

async function initializeKnowledgeBase() {
  try {
    console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–çŸ¥è­˜åº«...');
    
    // ç¢ºä¿è³‡æ–™åº«é€£æ¥
    if (!AppDataSource.isInitialized) {
      await AppDataSource.initialize();
      console.log('âœ… è³‡æ–™åº«é€£æ¥æˆåŠŸ');
    }

    const knowledgeBaseRepo = AppDataSource.getRepository(SupportKnowledgeBase);
    
    // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ•¸æ“š
    const existingCount = await knowledgeBaseRepo.count();
    if (existingCount > 0) {
      console.log(`âš ï¸  çŸ¥è­˜åº«å·²æœ‰ ${existingCount} ç­†è³‡æ–™`);
      const readline = await import('readline');
      const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
      });
      
      const answer = await new Promise<string>((resolve) => {
        rl.question('æ˜¯å¦è¦æ¸…ç©ºç¾æœ‰è³‡æ–™ä¸¦é‡æ–°åˆå§‹åŒ–ï¼Ÿ(y/n): ', resolve);
      });
      
      rl.close();
      
      if (answer.toLowerCase() !== 'y') {
        console.log('âŒ ä½¿ç”¨è€…å–æ¶ˆåˆå§‹åŒ–');
        return;
      }
      
      // æ¸…ç©ºç¾æœ‰è³‡æ–™
      await knowledgeBaseRepo.delete({});
      console.log('âœ… å·²æ¸…ç©ºç¾æœ‰çŸ¥è­˜åº«è³‡æ–™');
    }

    let successCount = 0;
    let errorCount = 0;

    // æª¢æŸ¥åµŒå…¥æœå‹™æ˜¯å¦å¯ç”¨
    const embeddingAvailable = await embeddingService.isServiceAvailable();
    if (!embeddingAvailable) {
      console.log('âš ï¸  åµŒå…¥æœå‹™ä¸å¯ç”¨ï¼Œå°‡è·³éå‘é‡ç”Ÿæˆ');
    }

    for (const [index, data] of initialKnowledgeBase.entries()) {
      try {
        console.log(`\\nğŸ“ å‰µå»ºç¬¬ ${index + 1}/${initialKnowledgeBase.length} å€‹çŸ¥è­˜åº«é …ç›®...`);
        console.log(`   æ¨™é¡Œ: ${data.title}`);
        
        // å‰µå»ºçŸ¥è­˜åº«é …ç›®
        const knowledgeBase = new SupportKnowledgeBase();
        knowledgeBase.title = data.title;
        knowledgeBase.content = data.content;
        knowledgeBase.category = data.category;
        knowledgeBase.tags = data.tags;
        knowledgeBase.isActive = true;

        // å„²å­˜åˆ°è³‡æ–™åº«
        const savedKB = await knowledgeBaseRepo.save(knowledgeBase);
        console.log(`   âœ… åŸºæœ¬è³‡æ–™å„²å­˜æˆåŠŸ`);

        // ç”ŸæˆåµŒå…¥å‘é‡
        if (embeddingAvailable) {
          try {
            console.log(`   ğŸ§  ç”ŸæˆåµŒå…¥å‘é‡...`);
            const embedding = await embeddingService.generateKnowledgeBaseEmbedding(savedKB);
            savedKB.setEmbedding(embedding);
            await knowledgeBaseRepo.save(savedKB);
            console.log(`   âœ… åµŒå…¥å‘é‡ç”ŸæˆæˆåŠŸ (${embedding.length} ç¶­åº¦)`);
          } catch (embeddingError: any) {
            console.log(`   âš ï¸  åµŒå…¥å‘é‡ç”Ÿæˆå¤±æ•—: ${embeddingError.message}`);
          }
        }

        successCount++;

        // é¿å… API é€Ÿç‡é™åˆ¶
        if (embeddingAvailable && index < initialKnowledgeBase.length - 1) {
          console.log(`   â³ ç­‰å¾… 1 ç§’é¿å… API é€Ÿç‡é™åˆ¶...`);
          await new Promise(resolve => setTimeout(resolve, 1000));
        }

      } catch (error: any) {
        console.error(`âŒ å‰µå»ºçŸ¥è­˜åº«é …ç›®å¤±æ•—: ${data.title}`, error.message);
        errorCount++;
      }
    }

    console.log('\\n' + '='.repeat(50));
    console.log('ğŸ“Š çŸ¥è­˜åº«åˆå§‹åŒ–å®Œæˆ');
    console.log('='.repeat(50));
    console.log(`âœ… æˆåŠŸå‰µå»º: ${successCount} å€‹é …ç›®`);
    console.log(`âŒ å¤±æ•—: ${errorCount} å€‹é …ç›®`);
    
    if (embeddingAvailable) {
      console.log(`ğŸ§  åµŒå…¥å‘é‡: å·²ç‚ºæ‰€æœ‰é …ç›®ç”Ÿæˆå‘é‡åµŒå…¥`);
    } else {
      console.log(`âš ï¸  åµŒå…¥å‘é‡: æœªç”Ÿæˆï¼ˆéœ€è¦ OpenAI API Keyï¼‰`);
    }

    // ç²å–æœ€çµ‚çµ±è¨ˆ
    const finalStats = await knowledgeBaseRepo.count();
    console.log(`ğŸ“ˆ çŸ¥è­˜åº«ç¸½æ•¸: ${finalStats} å€‹é …ç›®`);
    
    if (successCount > 0) {
      console.log('\\nğŸ‰ çŸ¥è­˜åº«åˆå§‹åŒ–æˆåŠŸï¼');
      console.log('ğŸ’¡ ç¾åœ¨å¯ä»¥æ¸¬è©¦èªç¾©æœå°‹åŠŸèƒ½ï¼šnpm run test:semantic-search');
    }

  } catch (error) {
    console.error('ğŸ’¥ çŸ¥è­˜åº«åˆå§‹åŒ–å¤±æ•—:', error);
    process.exit(1);
  } finally {
    if (AppDataSource.isInitialized) {
      await AppDataSource.destroy();
      console.log('âœ… è³‡æ–™åº«é€£æ¥å·²é—œé–‰');
    }
  }
}

// æª¢æŸ¥æ˜¯å¦ç›´æ¥åŸ·è¡Œæ­¤è…³æœ¬
if (import.meta.url === `file://${process.argv[1]}`) {
  initializeKnowledgeBase().catch(console.error);
}

export { initializeKnowledgeBase, initialKnowledgeBase };